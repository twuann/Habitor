# Implementation Plan

- [x] 1. Setup Firebase v√† Project Configuration
  - [x] 1.1 Add Firebase dependencies to gradle files
    - Add google-services plugin to project-level build.gradle
    - Add Firebase BoM, Firestore, and FCM dependencies to app-level build.gradle
    - Add jqwik dependency for property-based testing
    - _Requirements: 1.1, 1.4_
  - [x] 1.2 Create Firebase setup documentation file
    - Create FIREBASE_SETUP.md with step-by-step instructions
    - Include screenshots placeholders and configuration examples
    - _Requirements: 1.1, 1.2, 1.3_
  - [x] 1.3 Update AndroidManifest.xml with required permissions and receivers
    - Add INTERNET, POST_NOTIFICATIONS, SCHEDULE_EXACT_ALARM, RECEIVE_BOOT_COMPLETED permissions
    - Register BootReceiver for alarm rescheduling
    - _Requirements: 4.5_

- [x] 2. Enhance Data Models
  - [x] 2.1 Create Priority and RepeatPattern enums
    - Implement Priority enum with HIGH, MEDIUM, LOW and sortOrder
    - Implement RepeatPattern enum with DAILY, WEEKLY, CUSTOM
    - _Requirements: 9.1, 5.1_
  - [x] 2.2 Update Habit entity with new fields
    - Add reminderTime, isReminderEnabled, repeatPattern, repeatDays, customIntervalDays
    - Add priority, category, firebaseId, lastSyncedAt, streakCount
    - Add toFirestoreMap() and fromFirestoreMap() methods
    - _Requirements: 11.1, 11.2, 11.3_
  - [ ]* 2.3 Write property test for Habit serialization round-trip
    - **Property 2: Habit Serialization Round-Trip**
    - **Validates: Requirements 11.2, 11.3**
  - [x] 2.4 Create Category entity
    - Define Category with id, name, color, isDefault fields
    - Add default categories: Health, Work, Personal, Learning, Other
    - _Requirements: 10.1_
  - [x] 2.5 Create SyncOperation entity for offline queue
    - Define SyncOperation with operationType, habitId, habitJson, createdAt
    - _Requirements: 3.5_
  - [x] 2.6 Create database migration from version 2 to 3
    - Add new columns to Habit table with default values
    - Create Category and SyncQueue tables
    - Preserve existing data
    - _Requirements: 11.5_
  - [ ]* 2.7 Write property test for database migration data preservation
    - **Property 12: Database Migration Data Preservation**
    - **Validates: Requirements 11.5**

- [x] 3. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 4. Implement Core Utilities
  - [x] 4.1 Create StreakCalculator utility class
    - Implement calculateCurrentStreak() method
    - Implement calculateLongestStreak() method
    - Implement calculateCompletionRate() method
    - _Requirements: 11.4, 8.2_
  - [ ]* 4.2 Write property test for streak calculation
    - **Property 3: Streak Calculation Correctness**
    - **Validates: Requirements 11.4**
  - [ ]* 4.3 Write property test for statistics calculation
    - **Property 15: Statistics Calculation Accuracy**
    - **Validates: Requirements 8.2**
  - [x] 4.4 Create RepeatPatternFormatter utility class
    - Implement formatToReadable() for human-readable display
    - Implement parseFromString() for reverse conversion
    - _Requirements: 5.5_
  - [ ]* 4.5 Write property test for repeat pattern formatting round-trip
    - **Property 6: Repeat Pattern Formatting Round-Trip**
    - **Validates: Requirements 5.5**
  - [x] 4.6 Create DeviceIdHelper utility class
    - Generate unique device-based user ID
    - Save and retrieve from SharedPreferences
    - _Requirements: 2.2_

- [x] 5. Implement Repository Layer
  - [x] 5.1 Create HabitRepository class
    - Implement CRUD operations with dual-write (Room + Firestore)
    - Implement getAllHabits(), getHabitsByCategory(), getHabitsByPriority()
    - _Requirements: 3.1, 3.2, 3.3_
  - [ ]* 5.2 Write property test for priority sorting
    - **Property 4: Priority Sorting Order**
    - **Validates: Requirements 9.2**
  - [ ]* 5.3 Write property test for category filtering
    - **Property 5: Category Filtering Accuracy**
    - **Validates: Requirements 10.4**
  - [x] 5.4 Create SyncManager class
    - Implement syncOnAppLaunch() method
    - Implement queueOfflineChange() and processOfflineQueue()
    - Implement isOnline() connectivity check
    - _Requirements: 3.4, 3.5_
  - [ ]* 5.5 Write property test for sync dual-write consistency
    - **Property 10: Sync Dual-Write Consistency**
    - **Validates: Requirements 3.1, 3.2, 3.3**
  - [ ]* 5.6 Write property test for offline queue preservation
    - **Property 11: Offline Queue Preservation**
    - **Validates: Requirements 3.5**

- [x] 6. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 7. Implement Alarm and Notification System
  - [x] 7.1 Create AlarmScheduler class
    - Implement scheduleReminder() with AlarmManager
    - Implement cancelReminder() method
    - Implement rescheduleAllReminders() for boot receiver
    - Implement snoozeReminder() method
    - _Requirements: 4.2, 4.4, 4.5, 6.3_
  - [ ]* 7.2 Write property test for alarm scheduling consistency
    - **Property 7: Alarm Scheduling Consistency**
    - **Validates: Requirements 4.2**
  - [ ]* 7.3 Write property test for snooze time accuracy
    - **Property 8: Snooze Time Accuracy**
    - **Validates: Requirements 6.3**
  - [x] 7.4 Enhance NotificationHelper class
    - Add showHabitReminder() with action buttons
    - Add createMarkCompleteIntent() and createSnoozeIntent()
    - Add showGroupedNotifications() for multiple reminders
    - _Requirements: 6.1, 6.2, 6.3, 6.5_
  - [ ]* 7.5 Write property test for notification action completion recording
    - **Property 13: Notification Action Completion Recording**
    - **Validates: Requirements 6.2**
  - [x] 7.6 Update AlarmReceiver to use enhanced notifications
    - Extract habit info from intent
    - Call appropriate NotificationHelper method
    - _Requirements: 4.3_
  - [x] 7.7 Create BootReceiver for alarm rescheduling
    - Listen for BOOT_COMPLETED action
    - Call AlarmScheduler.rescheduleAllReminders()
    - _Requirements: 4.5_
  - [x] 7.8 Create NotificationActionReceiver for handling notification actions
    - Handle Mark Complete action
    - Handle Snooze action
    - _Requirements: 6.2, 6.3_

- [x] 8. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 9. Update HabitDao with new queries
  - [x] 9.1 Add queries for priority and category filtering
    - Add getHabitsByPriority() query
    - Add getHabitsByCategory() query
    - Add getAllHabitsSortedByPriority() query
    - _Requirements: 9.2, 9.4, 10.4_
  - [x] 9.2 Add queries for reminder management
    - Add getHabitsWithReminders() query
    - Add updateReminderSettings() query
    - _Requirements: 4.1, 4.4_
  - [x] 9.3 Add queries for sync operations
    - Add getUnsyncedHabits() query
    - Add updateSyncStatus() query
    - _Requirements: 3.4_

- [x] 10. Implement UI - Home Screen Enhancement
  - [x] 10.1 Create HabitCardAdapter with new layout
    - Display habit name, streak, next reminder time
    - Show priority indicator (colored badge)
    - Show category label
    - Add completion checkbox with animation
    - _Requirements: 7.1, 7.2, 9.3_
  - [x] 10.2 Update HomeFragment with enhanced functionality
    - Implement card tap for completion toggle
    - Implement long-press context menu (Edit, Delete, Share)
    - Add progress indicator for today's completion
    - _Requirements: 7.3, 7.4_
  - [ ]* 10.3 Write property test for completion toggle idempotence
    - **Property 9: Completion Toggle Idempotence**
    - **Validates: Requirements 7.3**
  - [x] 10.4 Add celebration animation for all habits completed
    - Detect when all habits are done for the day
    - Show congratulatory message with animation
    - _Requirements: 7.5_
  - [x] 10.5 Implement filtering and sorting UI
    - Add filter chips for priority and category
    - Implement sort by priority
    - _Requirements: 9.4, 10.4_

- [x] 11. Implement UI - Habit Detail Screen
  - [x] 11.1 Create HabitDetailFragment
    - Display calendar view with completion history
    - Show statistics (current streak, longest streak, completion rate)
    - _Requirements: 8.1, 8.2_
  - [ ]* 11.2 Write property test for category completion rate calculation
    - **Property 14: Category Completion Rate Calculation**
    - **Validates: Requirements 10.5**
  - [x] 11.3 Implement calendar view with streak highlighting
    - Highlight completed days with distinct color
    - Show streak connections between consecutive days
    - Support month navigation with swipe
    - _Requirements: 8.4, 8.5_
  - [x] 11.4 Create ReminderSettingsBottomSheet
    - Time picker for reminder time
    - Repeat pattern selector (Daily, Weekly, Custom)
    - Day selector for weekly pattern
    - Interval input for custom pattern
    - _Requirements: 8.3, 5.1, 5.2, 5.3, 5.4_

- [x] 12. Implement UI - Add/Edit Habit
  - [x] 12.1 Create AddEditHabitBottomSheet
    - Name and note input fields
    - Priority selector (High, Medium, Low buttons)
    - Category dropdown
    - Reminder toggle and time picker
    - Repeat pattern configuration
    - _Requirements: 4.1, 5.1, 9.1, 10.1_
  - [x] 12.2 Integrate with HabitRepository for save/update
    - Call repository methods on save
    - Schedule/cancel alarms based on reminder settings
    - _Requirements: 3.1, 3.2, 4.2, 4.4_

- [x] 13. Implement Category Management
  - [x] 13.1 Create CategoryRepository
    - CRUD operations for categories
    - Sync with Firestore
    - _Requirements: 10.3_
  - [x] 13.2 Implement category grouping in HomeFragment
    - Group habits by category with collapsible sections
    - Show category headers with completion stats
    - _Requirements: 10.2, 10.5_

- [x] 14. Update Onboarding Flow
  - [x] 14.1 Update OnboardingActivity
    - Generate device user ID on completion
    - Initialize Firestore user document
    - _Requirements: 2.2, 2.3_
  - [ ]* 14.2 Write property test for onboarding skip consistency
    - **Property 1: Onboarding Skip Consistency**
    - **Validates: Requirements 2.4**
  - [x] 14.3 Update PreferenceHelper with new methods
    - Add saveDeviceUserId() and getDeviceUserId()
    - Add methods for sync preferences
    - _Requirements: 2.2, 2.5_

- [x] 15. Implement High Priority End-of-Day Reminder
  - [x] 15.1 Create EndOfDayReminderService
    - Check for incomplete high priority habits at 8 PM
    - Send additional reminder notification
    - _Requirements: 9.5_

- [x] 16. Final Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.
